#!/bin/bash
#set -x

#bark token
BARK_TOKEN="xxxxxxxxxxxxxxxxxxxxxx"
#wechat/wecom id and token
WECOM_ID="xxxxxxxxxxxxxxxxxx"
WECOM_SECRET="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
WECOM_AGENT_ID="1111111"
WECOM_TO_USER="uuuuuu"

CURL_ARGS="--silent --location"

#set default title and msg
title=${1:-$(hostname)}
msg=${2:-$(basename "$(pwd)")}
channel=${3:-b}

#bark
if [[ $channel == *"b"* ]]; then
  curl -X POST "https://api.day.app/$BARK_TOKEN" \
    --data-urlencode "title=$title" \
    --data-urlencode "body=$msg" \
    $CURL_ARGS >>/dev/null 2>&1 &
fi

#wechat
if [[ $channel == *"w"* ]]; then
  tmp_token=$(curl "https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=${WECOM_ID}&corpsecret=${WECOM_SECRET}" -s | sed 's/.*access_token":"\([^"]*\)".*/\1/g')
  t=${title//\"/\\\"/}
  m=${msg//\"/\\\"/}
  curl -X "POST" "https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=$tmp_token" -H "Content-Type: text/plain; charset=utf-8" \
    -d "{ \"touser\": \"${WECOM_TO_USER}\", \"msgtype\": \"text\", \"agentid\": \"${WECOM_AGENT_ID}\", \"text\": { \"content\": \"${t}\n${m}\" } }" $CURL_ARGS >>/dev/null 2>&1 &
fi